export DISABLE_AUTO_TITLE=true

export HOMEBREW_ROOT=/opt/boxen/homebrew # brew --prefix
export HOMEBREW_CACHE=/opt/boxen/cache/homebrew # brew --cache
export HOMEBREW_NO_INSTALL_CLEANUP=1 # handled in crontab
export HOMEBREW_AUTO_UPDATE_SECS=$((6 * 60 * 60)) # 6 hours

export CFLAGS="-I$HOMEBREW_ROOT/include"
export LDFLAGS="-L$HOMEBREW_ROOT/lib"

# Add homebrew'd stuff to the path.
export PATH=$HOMEBREW_ROOT/bin:$HOMEBREW_ROOT/sbin:$PATH

# Add homebrew'd stuff to the manpath.
export MANPATH=$HOMEBREW_ROOT/share/man:$MANPATH

# Allow bundler to use all the cores for parallel installation
export BUNDLE_JOBS=4

# Make all the fancy `hub` shortcuts available via `git`.
eval "$($HOMEBREW_ROOT/bin/hub alias -s)"

alias ql='qlmanage -p'
alias mcjpeg="$HOMEBREW_ROOT/opt/mozjpeg/bin/cjpeg"
alias mdjpeg="$HOMEBREW_ROOT/opt/mozjpeg/bin/djpeg"
alias mjpegtrans="$HOMEBREW_ROOT/opt/mozjpeg/bin/jpegtrans"

# Add Adobe Font Development Tools to PATH
export FDK_EXE="$HOME/bin/FDK/Tools/osx"
export PATH=$PATH:$FDK_EXE

export EDITOR=$HOMEBREW_ROOT/bin/vim

# Load rbenv
(( $+commands[rbenv] )) && eval "$(rbenv init - --no-rehash)"

# tabtab source for electron-forge package
# uninstall by removing these lines or running `tabtab uninstall electron-forge`
[[ -f ~/.nodenv/versions/8.11.1/lib/node_modules/electron-forge/node_modules/tabtab/.completions/electron-forge.zsh ]] && . ~/.nodenv/versions/8.11.1/lib/node_modules/electron-forge/node_modules/tabtab/.completions/electron-forge.zsh

function view_applescript_interface_items_for {
  # Adapted from http://hints.macworld.com/article.php?story=20111208191312748
  # Useful for finding items that can be scripted with System Events in
  # AppleScript.
  osascript <<-eos | perl -pe '$_ =~ s/, /\n/g'
  set appname to "$1" -------------------------- Set this to the App you want to look at

  set winstuff to "defaultval"
  set menustuff to "defaultval"

  tell application appname
    activate
  end tell

  tell application "System Events"
    tell process appname
      set winstuff to entire contents of front window
      set menustuff to entire contents of menu bar 1
    end tell
  end tell
  return winstuff & menustuff -- comment this out to get just winstuff
  --return winstuff -- comment this out too to get just menustuff
  --return menustuff
eos
}

# Unlock the screen from the command line
# Adapted from: https://apple.stackexchange.com/a/230912
function unlock_screen {
  echo -n "Please enter your password: "
  read -s password
  osascript <<-eos
    tell application "System Events"
      key code 123 -- left arrow wakes the screen
      delay 0.8 -- wait for the login screen
      keystroke "$password" -- types the password
      key code 36 -- Enter - logs in
    end tell
eos
}

# Locking the screen is much easier from 10.13 onward.
# Remove this check and the extra code after upgrading.
if [[ ${$(sw_vers -productVersion)%\.[0-9]} -lt '10.13' ]] {
  # Lock the screen - Workaround since I haven't updated past Sierra yet
  # https://stackoverflow.com/a/41196453
  function lock_screen() {
    echo Locking screen please wait...
    PATH=/usr/bin:$PATH xcrun swift <<-eos >/dev/null 2>&1
    import Foundation

    CGEvent(mouseEventSource: nil, mouseType: .mouseMoved, mouseCursorPosition: CGPoint(x:0.0, y:0.0), mouseButton: .left)!.post(tap: CGEventTapLocation.cghidEventTap)
eos
  }
} else {
  # Lock the screen
  # https://apple.stackexchange.com/a/316058
  # Requires at least 10.13 (High Sierra)
  function lock_screen {
    osascript <<-eos
      activate application "SystemUIServer"
      tell application "System Events"
        tell process "SystemUIServer" to keystroke "q" using {command down, control down}
      end tell
eos
  }
}

# List Brew formula installed by user (installed_on_request)
function installed_on_request() {
  brew list | xargs brew info --json | ruby -r json -ne 'j = JSON.parse($_); o = j.reduce([]) { |a, v| a << v["name"] unless v["installed"][0]["installed_on_request"].nil?; a }; puts o.join("\n")'
}
